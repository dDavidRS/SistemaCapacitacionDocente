{% extends 'Sistema/layouts/menu_admin.html' %}
{% load static %}

{% block extra_css %}
    <meta charset="UTF-8">
    <title>Criterios de Selección de Instructor</title>
    <link rel="stylesheet" href="{% static 'Sistema/css/criterios/criterios.css' %}">
{% endblock %}

{% block content %}

    <section class="criterios-container main-content">

        {# --- 1. BOTÓN DE DESCARGA AUTOMÁTICO --- #}
        {% if download_data %}
            <div class="alert alert-success text-center shadow-sm web-only" style="border-left: 5px solid #1b396a; margin-bottom: 30px; padding: 20px; background-color: #d1e7dd;">
                <h4 style="color: #1b396a; margin-top: 0;"><i class="fa-solid fa-circle-check"></i> ¡Guardado Exitosamente!</h4>
                <p style="font-size: 14px; color: #0f5132;">El formato se ha registrado. Puedes descargar la versión firmada aquí:</p>

                <a href="{% url 'descargar_pdf' download_data.tipo download_data.pk %}"
                   class="btn"
                   style="background-color: #1b396a; color: white; border-radius: 50px; padding: 10px 30px; text-decoration: none; font-weight: bold; display: inline-block; margin-top: 10px;">
                    <i class="fa-solid fa-file-pdf me-2"></i> Descargar PDF
                </a>
            </div>
        {% endif %}

        {# --- MENSAJES DE ERROR --- #}
        {% if form.errors %}
            <div style="background-color: #f8d7da; color: #721c24; padding: 10px; margin-bottom: 20px; border: 1px solid #f5c6cb; border-radius: 5px;">
                <strong>No se pudo guardar. Revisa lo siguiente:</strong>
                <ul>
                {% for field in form %}
                    {% for error in field.errors %}
                        <li>{{ field.label }}: {{ error }}</li>
                    {% endfor %}
                {% endfor %}
                </ul>
            </div>
        {% endif %}

        <form method="POST" class="criterios-form-body">
            {% csrf_token %}

            {# --- CINTILLA ESTANDARIZADA --- #}
            <header class="document-header-print">
                <table class="cintilla-table">
                    <tr>
                        <td class="col-logos">
                            <div class="logos-container">
                                <img src="{% static 'Sistema/img/LogoTecnmChiquis.png' %}" alt="TecNM" class="logo-img logo-tecnm">
                                <img src="{% static 'Sistema/img/LogoItrNoFondo.png' %}" alt="Tec Reynosa" class="logo-img logo-tec">
                            </div>
                        </td>
                        <td class="col-center">
                            <div class="center-content">
                                <h1 class="cintilla-main-title">CRITERIOS PARA LA SELECCIÓN DE INSTRUCTOR</h1>
                                <div class="cintilla-norma">Referencia a la Norma: ISO 9001:2015 7.2 7.3</div>
                            </div>
                        </td>
                        <td class="col-meta">
                            <div class="meta-row"><strong>Código:</strong> ITR-AC-F58</div>
                            <div class="meta-row"><strong>Versión:</strong> 4</div>
                            <div class="meta-row"><strong>Fecha de Emisión:</strong><br>septiembre de 2022</div>
                            <div class="meta-row"><strong>Página:</strong> 1 de 2</div>
                        </td>
                    </tr>
                </table>
            </header>

            <h2 class="institute-title">INSTITUTO TECNOLÓGICO DE REYNOSA</h2>
            <h2 class="form-subtitle">CRITERIOS PARA LA SELECCIÓN DE INSTRUCTOR</h2>

            {# --- 1. INFORMACIÓN BÁSICA --- #}
            <section class="form-section">
                <div class="form-row">
                    <label>Nombre del Instructor: (1)</label>
                    <input type="text" name="nombre_instructor" class="input-line full-width" value="{{ form.nombre_instructor.value|default:'' }}" required>
                </div>

                <div class="form-row">
                    <label>Fecha de Evaluación: (2)</label>
                    <input type="date" name="fecha_evaluacion" class="input-line full-width" value="{{ form.fecha_evaluacion.value|date:'Y-m-d'|default:'' }}" required>
                </div>

                <div class="form-row">
                    <label>Nombre del Curso a Impartir: (3)</label>
                    <input type="text" name="nombre_curso" class="input-line full-width" value="{{ form.nombre_curso.value|default:'' }}" required>
                </div>

                <div class="form-row">
                    <label>Nombre de la Empresa o Plantel: (4)</label>
                    <input type="text" name="empresa" class="input-line full-width" value="{{ form.empresa.value|default:'' }}" required>
                </div>
            </section>

            {# --- 2. TABLA DE CRITERIOS --- #}
            <section class="form-section mt-20">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th width="40%">CRITERIO (5)</th>
                            <th width="8%">1</th>
                            <th width="8%">2</th>
                            <th width="8%">3</th>
                            <th width="8%">4</th>
                            <th width="8%">5</th>
                            <th width="20%">TOTAL (6)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="text-left">1. FORMACIÓN PROFESIONAL RELACIONADA A LA CAPACITACIÓN A IMPARTIR</td>
                            <td class="center-text"><input type="radio" name="criterio_1" value="1" required {% if form.criterio_1.value|stringformat:"s" == "1" %}checked{% endif %}></td>
                            <td class="center-text"><input type="radio" name="criterio_1" value="2" required {% if form.criterio_1.value|stringformat:"s" == "2" %}checked{% endif %}></td>
                            <td class="center-text"><input type="radio" name="criterio_1" value="3" required {% if form.criterio_1.value|stringformat:"s" == "3" %}checked{% endif %}></td>
                            <td class="center-text"><input type="radio" name="criterio_1" value="4" required {% if form.criterio_1.value|stringformat:"s" == "4" %}checked{% endif %}></td>
                            <td class="center-text"><input type="radio" name="criterio_1" value="5" required {% if form.criterio_1.value|stringformat:"s" == "5" %}checked{% endif %}></td>
                            <td class="center-text"><input type="number" class="row-total input-clean center-text" readonly value="{{ form.criterio_1.value|default:'' }}"></td>
                        </tr>
                        <tr>
                            <td class="text-left">2. EXPERIENCIA EN CAPACITACIÓN Y EN LA TEMÁTICA A IMPARTIR</td>
                            <td class="center-text"><input type="radio" name="criterio_2" value="1" required {% if form.criterio_2.value|stringformat:"s" == "1" %}checked{% endif %}></td>
                            <td class="center-text"><input type="radio" name="criterio_2" value="2" required {% if form.criterio_2.value|stringformat:"s" == "2" %}checked{% endif %}></td>
                            <td class="center-text"><input type="radio" name="criterio_2" value="3" required {% if form.criterio_2.value|stringformat:"s" == "3" %}checked{% endif %}></td>
                            <td class="center-text"><input type="radio" name="criterio_2" value="4" required {% if form.criterio_2.value|stringformat:"s" == "4" %}checked{% endif %}></td>
                            <td class="center-text"><input type="radio" name="criterio_2" value="5" required {% if form.criterio_2.value|stringformat:"s" == "5" %}checked{% endif %}></td>
                            <td class="center-text"><input type="number" class="row-total input-clean center-text" readonly value="{{ form.criterio_2.value|default:'' }}"></td>
                        </tr>
                        <tr>
                            <td class="text-left">3. MATERIALES DIDÁCTICOS A UTILIZAR</td>
                            <td class="center-text"><input type="radio" name="criterio_3" value="1" required {% if form.criterio_3.value|stringformat:"s" == "1" %}checked{% endif %}></td>
                            <td class="center-text"><input type="radio" name="criterio_3" value="2" required {% if form.criterio_3.value|stringformat:"s" == "2" %}checked{% endif %}></td>
                            <td class="center-text"><input type="radio" name="criterio_3" value="3" required {% if form.criterio_3.value|stringformat:"s" == "3" %}checked{% endif %}></td>
                            <td class="center-text"><input type="radio" name="criterio_3" value="4" required {% if form.criterio_3.value|stringformat:"s" == "4" %}checked{% endif %}></td>
                            <td class="center-text"><input type="radio" name="criterio_3" value="5" required {% if form.criterio_3.value|stringformat:"s" == "5" %}checked{% endif %}></td>
                            <td class="center-text"><input type="number" class="row-total input-clean center-text" readonly value="{{ form.criterio_3.value|default:'' }}"></td>
                        </tr>
                        <tr>
                            <td class="text-left">4. DISPONIBILIDAD DE TIEMPO</td>
                            <td class="center-text"><input type="radio" name="criterio_4" value="1" required {% if form.criterio_4.value|stringformat:"s" == "1" %}checked{% endif %}></td>
                            <td class="center-text"><input type="radio" name="criterio_4" value="2" required {% if form.criterio_4.value|stringformat:"s" == "2" %}checked{% endif %}></td>
                            <td class="center-text"><input type="radio" name="criterio_4" value="3" required {% if form.criterio_4.value|stringformat:"s" == "3" %}checked{% endif %}></td>
                            <td class="center-text"><input type="radio" name="criterio_4" value="4" required {% if form.criterio_4.value|stringformat:"s" == "4" %}checked{% endif %}></td>
                            <td class="center-text"><input type="radio" name="criterio_4" value="5" required {% if form.criterio_4.value|stringformat:"s" == "5" %}checked{% endif %}></td>
                            <td class="center-text"><input type="number" class="row-total input-clean center-text" readonly value="{{ form.criterio_4.value|default:'' }}"></td>
                        </tr>
                        <tr>
                            <td class="text-left">5. CERTIFICACIONES Y ACREDITACIONES RELACIONADAS AL ÁREA DE CAPACITACIÓN</td>
                            <td class="center-text"><input type="radio" name="criterio_5" value="1" required {% if form.criterio_5.value|stringformat:"s" == "1" %}checked{% endif %}></td>
                            <td class="center-text"><input type="radio" name="criterio_5" value="2" required {% if form.criterio_5.value|stringformat:"s" == "2" %}checked{% endif %}></td>
                            <td class="center-text"><input type="radio" name="criterio_5" value="3" required {% if form.criterio_5.value|stringformat:"s" == "3" %}checked{% endif %}></td>
                            <td class="center-text"><input type="radio" name="criterio_5" value="4" required {% if form.criterio_5.value|stringformat:"s" == "4" %}checked{% endif %}></td>
                            <td class="center-text"><input type="radio" name="criterio_5" value="5" required {% if form.criterio_5.value|stringformat:"s" == "5" %}checked{% endif %}></td>
                            <td class="center-text"><input type="number" class="row-total input-clean center-text" readonly value="{{ form.criterio_5.value|default:'' }}"></td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr>
                            <td class="text-left bold-cell">TOTAL DE PUNTAJE (7)</td>
                            <td colspan="5"></td>
                            <td class="center-text"><input type="number" id="id_crit_total_puntaje" name="total_puntaje" class="input-clean center-text bold-cell" readonly value="{{ form.total_puntaje.value|default:'0' }}"></td>
                        </tr>
                    </tfoot>
                </table>
            </section>

            {# --- 3. NOTA Y ACEPTACIÓN --- #}
            <section class="form-section mt-20">
                <div class="nota-escala">
                    <strong>Nota:</strong> Evaluar considerando la siguiente escala: &nbsp;
                    <span>1 Malo | 2 Regular | 3 Bien | 4 Muy bien | 5 Excelente</span>
                </div>

                <div class="approval-section">
                    <span class="bold-cell">Aceptado (8):</span>
                    <label><input type="radio" name="aceptado" value="si" required {% if form.aceptado.value == 'si' %}checked{% endif %}> SÍ</label>
                    <label><input type="radio" name="aceptado" value="no" required {% if form.aceptado.value == 'no' %}checked{% endif %}> NO</label>
                </div>
            </section>

            {# --- 4. FIRMAS --- #}
            <div class="signature-section">
                <div class="signature-box">
                    <p>Evaluó (9)</p>
                    <div class="signature-line-draw"></div>
                    <div class="signature-text">Nombre, puesto y firma</div>
                </div>
                <div class="signature-box">
                    <p>Autorizó (10)</p>
                    <div class="signature-line-draw"></div>
                    <div class="signature-text">Nombre, puesto y firma</div>
                </div>
            </div>

            <div class="form-submit-row web-only">
                <button type="submit">Guardar Criterios</button>
            </div>

        </form>

    </section>

    {# --- SCRIPT PARA SUMAR TOTALES (Solo funciona en Web) --- #}
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.querySelector('.criterios-form-body');

            // Actualización dinámica del total
            form.addEventListener('change', (event) => {
                // Ahora detectamos 'criterio_' en lugar de 'criterio_..._score'
                if (event.target.type === 'radio' && event.target.name.startsWith('criterio_') && !event.target.name.includes('aceptado')) {
                    const row = event.target.closest('tr');
                    const totalInput = row.querySelector('.row-total');
                    if (totalInput) totalInput.value = event.target.value;
                    updateTotalPuntaje();
                }
            });

            function updateTotalPuntaje() {
                let total = 0;
                form.querySelectorAll('.row-total').forEach(input => {
                    const val = parseInt(input.value, 10);
                    if (!isNaN(val)) total += val;
                });
                const totalInput = form.querySelector('#id_crit_total_puntaje');
                if (totalInput) totalInput.value = total;
            }
        });
    </script>

{% endblock %}