{% extends 'Sistema/layouts/menu_admin.html' %}
{% load static %}

{% block extra_css %}
    <meta charset="UTF-8">
    <title>Estadísticas | TecNM</title>
    <link rel="stylesheet" href="{% static 'Sistema/css/estadisticas/estadisticas.css' %}?v=3">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        .main-wrapper {
            margin-top: 160px !important; /* Forzamos el margen con !important */
            padding: 20px;
        }
    </style>
{% endblock %}

{% block content %}
<div class="container-fluid main-wrapper">

    <div class="card-custom">

        <div class="page-header d-flex justify-content-between align-items-center">
            <div>
                <h5 class="page-title">
                    <i class="fa-solid fa-chart-pie me-2"></i>Indicadores de Satisfacción
                </h5>
                <p class="text-muted small mb-0">Análisis gráfico de las encuestas realizadas a los instructores.</p>
            </div>
            <div class="text-end text-muted small">
                <i class="fa-regular fa-calendar"></i> Ciclo Actual
            </div>
        </div>

        <div class="filters-box mb-4">
            <form method="GET" class="row g-3 align-items-end">

                <div class="col-md-4">
                    <label class="form-label fw-bold small text-muted">Filtrar por Periodo:</label>
                    <div class="input-group">
                        <span class="input-group-text bg-light"><i class="fa-solid fa-calendar-days"></i></span>
                        <select name="periodo" class="form-select">
                            <option value="">-- Todos los periodos --</option>
                            {% for p in periodos %}
                                <option value="{{ p }}" {% if p == periodo_actual %}selected{% endif %}>{{ p }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="col-md-5">
                    <label class="form-label fw-bold small text-muted">Filtrar por Instructor:</label>
                    <div class="input-group">
                        <span class="input-group-text bg-light"><i class="fa-solid fa-user-tie"></i></span>
                        <select name="facilitador" class="form-select">
                            <option value="">-- Todos los instructores --</option>
                            {% for f in facilitadores %}
                                <option value="{{ f }}" {% if f == facilitador_actual %}selected{% endif %}>{{ f }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="col-md-3 d-flex gap-2">
                    <button type="submit" class="btn btn-tecnm w-100">
                        <i class="fa-solid fa-filter"></i> Aplicar
                    </button>
                    {% if periodo_actual or facilitador_actual %}
                        <a href="{% url 'Estadisticas' %}" class="btn btn-outline-secondary" title="Limpiar filtros">
                            <i class="fa-solid fa-eraser"></i>
                        </a>
                    {% endif %}
                </div>
            </form>
        </div>

        <div class="chart-wrapper">
            <canvas id="myChart"></canvas>
        </div>

        <div class="mt-4 border-top pt-3 text-center text-muted small">
            Tecnológico Nacional de México - Instituto Tecnológico de Reynosa
        </div>

    </div>
</div>

<script>
    const ctx = document.getElementById('myChart');
    const dataValues = {{ datos_grafica|safe }};
    const dataLabels = {{ labels_grafica|safe }};

    // Configuramos un degradado para las barras (Toque estético extra)
    const gradient = ctx.getContext('2d').createLinearGradient(0, 0, 0, 400);
    gradient.addColorStop(0, 'rgba(27, 57, 106, 0.9)'); // Azul fuerte arriba
    gradient.addColorStop(1, 'rgba(27, 57, 106, 0.4)'); // Azul suave abajo

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: dataLabels,
            datasets: [{
                label: 'Promedio de Calificación (1-5)',
                data: dataValues,
                backgroundColor: gradient,
                borderColor: '#1b396a',
                borderWidth: 1,
                borderRadius: 4, // Bordes redondeados en las barras
                barPercentage: 0.6, // Barras un poco más delgadas
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false, // Permite ajustar la altura por CSS
            plugins: {
                legend: { position: 'top' },
                tooltip: {
                    backgroundColor: '#1b396a',
                    titleFont: { size: 13 },
                    bodyFont: { size: 14 },
                    padding: 10,
                    callbacks: {
                        label: function(context) {
                            return ' Calif: ' + context.raw;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 5,
                    grid: { color: '#f0f0f0' }, // Rejilla suave
                    title: { display: true, text: 'Puntaje Promedio', font: {weight: 'bold'} }
                },
                x: {
                    grid: { display: false }, // Ocultar rejilla vertical para limpieza
                    title: { display: true, text: 'Preguntas de la Encuesta' }
                }
            }
        }
    });
</script>
{% endblock %}